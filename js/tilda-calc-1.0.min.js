function tcalc__init(recid,id_field){var el_rec=$("#rec"+recid),el_wrapper=el_rec.find("[data-input-lid="+id_field+"]"),el_resN=el_wrapper.find(".t-calc"),str_expr=el_resN.attr("data-calc-expr");if(void 0!==str_expr){var expr=tcalc__parseExpression(str_expr=str_expr.replace(/\s/g,"").replace(/,/g,"."));tcalc__cashOperandsFieldsEls(el_rec,expr),tcalc__cutAndHideFieldsValues(expr),!0!==expr.error?(tcalc__changeVal(el_wrapper,el_resN,tcalc__calcValue(expr)),setTimeout((function(){tcalc__changeVal(el_wrapper,el_resN,tcalc__calcValue(expr))}),1),el_rec.find(".t-input").on("keyup keydown input",(function(){setTimeout((function(){tcalc__changeVal(el_wrapper,el_resN,tcalc__calcValue(expr))}),1)})),el_rec.find(".t-select, .t-radio, .t-checkbox, .t-img-select").on("change",(function(){tcalc__changeVal(el_wrapper,el_resN,tcalc__calcValue(expr))})),el_rec.find(".t-inputquantity__btn").on("click",(function(){tcalc__changeVal(el_wrapper,el_resN,tcalc__calcValue(expr))})),el_rec.find(".t-range").on("click input change",(function(){tcalc__changeVal(el_wrapper,el_resN,tcalc__calcValue(expr))}))):console.log("Please check math expression or input names(especially spaces) in rec"+recid)}else console.log("Error: formula field is empty in rec"+recid)}function tcalc__changeVal(el_wrapper,el_resN,res){if(isNaN(res)?(el_resN.html(0),el_wrapper.find(".t-calc__hiddeninput").val(0)):(el_resN.html(res),el_wrapper.find(".t-calc__hiddeninput").val(res)),el_wrapper.find('input[type="hidden"][class^="t-calc__hidden__prod"]').length>0){var formParent=el_wrapper.parents(".t-form__inputsbox"),img=el_wrapper.find(".t-calc__hidden__prod_img").val()||"",title=el_wrapper.find(".t-calc__hidden__prod_title").val()||"NoName",expr={str:title,variables:[]},variables=expr.str.match(/[A-z0-9_]+/gi);for(var i in variables){var fieldRadio=formParent.find('[type="radio"][name="'+variables[i]+'"]:checked');if(1===fieldRadio.length)expr.variables.push({str:variables[i],value:fieldRadio.val()});else{var field=formParent.find('[name="'+variables[i]+'"]');1===field.length&&expr.variables.push({str:variables[i],value:field.val()})}}for(var j in expr.variables){var str=expr.variables[j].str,value=expr.variables[j].value;void 0!==str&&void 0!==value&&(title=title.replace(new RegExp(str),value))}var submit=formParent.find('[class$="-form__submit"]').find("button.t-submit"),order="#order:"+title+"="+res;""!==img&&(order+=":::image="+img),submit.attr("href",order),submit.attr("type","")}}function tcalc__calcValue(expr){tcalc__getFieldsValues(expr);for(var evalStr=expr.str,i=0;i<expr.operands.length;i++){var valToInsert=expr.operands[i].value;valToInsert=valToInsert<0?"(0"+valToInsert+")":valToInsert,evalStr=evalStr.replace(expr.operands[i].str,valToInsert)}try{var res=tcalc__evaluate(tcalc__parse(evalStr))}catch(err){console.log("Something went wrong in form calculator! Please, connect support or developers")}return Math.round(10*res)/10}function tcalc__parseExpression(str_expr){var chars=str_expr.split(""),operands=[],op=[],index=0,oplast=!0;operands[index]=Object.create(null),operands[index].str="";for(var c=0;c<chars.length;c++)"("!=chars[c]&&")"!=chars[c]&&("+"!=chars[c]&&"-"!=chars[c]&&"*"!=chars[c]&&"/"!=chars[c]||oplast?(operands[index].str+=chars[c],oplast=!1):(op[index]=chars[c],operands[++index]=Object.create(null),operands[index].str="",oplast=!0));return{str:str_expr,operands:operands,operators:op}}function tcalc__cashOperandsFieldsEls(el_rec,expr){for(var i=0;i<expr.operands.length;i++){var str=expr.operands[i].str;if($.isNumeric(str))expr.operands[i].type="number",expr.operands[i].value=1*expr.operands[i].str;else{var curOperandField=el_rec.find("[name="+str+"]");if(0===curOperandField.length)return console.log("Error: incorrect operand: "+str),void(expr.error=!0);expr.operands[i].type="variable",expr.operands[i].el_field=curOperandField}}}function tcalc__cutAndHideFieldsValues(expr){for(var i=0;i<expr.operands.length;i++){var operand=expr.operands[i];if("variable"===operand.type){var field=operand.el_field;if(field.hasClass("t-select"))for(var arr_options=field.find("option"),j=0;j<arr_options.length;j++){var option=arr_options[j],v;if(void 0!==(v=option.value)&&""!==v){var arr_v=v.split("=");option.value=arr_v[0],$(option).html(arr_v[0]),$(option).attr("data-calc-value",arr_v[1])}}if(field.hasClass("t-checkboxes__hiddeninput")||field.hasClass("t-checkbox")||field.hasClass("t-radio")){if(field.hasClass("t-checkboxes__hiddeninput"))var arr_els=operand.el_field.parents(".t-input-block").find(".t-checkbox");else var arr_els=field;for(var j=0;j<arr_els.length;j++){var el,parent,el_label=(parent=(el=$(arr_els[j])).hasClass("t-radio")?el.parents(".t-radio__control"):el.parents(".t-checkbox__control")).find(".t-checkbox__labeltext"),v=parent.text();if(el_label.length>0&&(v=el_label.text()),void 0!==v){var arr_v=v.split("=");if(0!==el.parents(".t-input-group_rd").length&&el.attr("value",arr_v[0]),el.attr("data-calc-value",arr_v[1]),el_label.length>0)el_label.text(arr_v[0]);else{var els=parent.children();parent.contents().last()[0].textContent=arr_v[0],parent.prepend(els)}}}}if(field.hasClass("t-img-select__hiddeninput")||field.hasClass("t-img-select")){if(field.hasClass("t-img-select__hiddeninput"))var arr_els=operand.el_field.parents(".t-input-block").find(".t-img-select");else var arr_els=field;for(var j=0;j<arr_els.length;j++){var el,parent,el_text=(parent=(el=$(arr_els[j])).parents(".t-img-select__control")).find(".t-img-select__text"),v,arr_v;if(void 0!==(v=el_text.text()))""===(arr_v=v.split("="))[0]||" "===arr_v[0]?el.attr("value",parent.find(".t-img-select__indicator").attr("data-original")):el.attr("value",arr_v[0]),el.attr("data-calc-value",arr_v[1]),el_text.text(arr_v[0])}}}}}function tcalc__getFieldsValues(expr){for(var i=0;i<expr.operands.length;i++)if("variable"==expr.operands[i].type){var field=expr.operands[i].el_field,isRadioImg=field.hasClass("t-img-select")&&"radio"===field.attr("type"),isCheckboxImg=field.hasClass("t-img-select__hiddeninput");if(field.hasClass("t-input")||field.hasClass("t-range")||field.hasClass("t-calc__hiddeninput")){var value=field.val();tcalc__getFieldsValues__saveToArr(expr.operands[i],value)}if(field.hasClass("t-select")){var option,value=field.find("option:selected").attr("data-calc-value");tcalc__getFieldsValues__saveToArr(expr.operands[i],value)}if(field.hasClass("t-radio")||field.hasClass("t-checkbox")||isRadioImg){var checkedEl,value=field.filter(":checked").attr("data-calc-value");tcalc__getFieldsValues__saveToArr(expr.operands[i],value)}if(field.hasClass("t-checkboxes__hiddeninput")||isCheckboxImg){for(var checkedEls=isCheckboxImg?field.parents(".t-input-block").find(".t-img-select:checked"):field.parents(".t-input-block").find(".t-checkbox:checked"),valSum=0,j=0;j<checkedEls.length;j++){var cb=checkedEls[j],value;value=void 0!==(value=$(cb).attr("data-calc-value"))?value.replace(/[^0-9.]/g,""):0,valSum+=parseFloat(value)}tcalc__getFieldsValues__saveToArr(expr.operands[i],valSum.toString())}}}function tcalc__getFieldsValues__saveToArr(operand,value){var isNegative=parseInt(value,10)<0;value=void 0!==value?value.replace(/,/g,".").replace(/[^0-9.]/g,""):"",operand.value=""===value?0:parseFloat(value),isNegative&&(operand.value=-operand.value)}function tcalc__evaluate(obj){switch(obj.type){case"number":return parseFloat(obj.value);case"+":return tcalc__evaluate(obj.left)+tcalc__evaluate(obj.right);case"-":return tcalc__evaluate(obj.left)-tcalc__evaluate(obj.right);case"*":return tcalc__evaluate(obj.left)*tcalc__evaluate(obj.right);case"/":return tcalc__evaluate(obj.left)/tcalc__evaluate(obj.right)}}function tcalc__parse(code){var opts={tokens:tcalc__tokenize(code),position:0},result=tcalc__parseExpr(opts);if(opts.position!==opts.tokens.length)throw new SyntaxError("unexpected '"+tcalc__peek(opts)+"'");return result}function tcalc__parseExpr(opts){for(var expr=tcalc__parseMulExpr(opts),t=tcalc__peek(opts);"+"===t||"-"===t;){var rhs;tcalc__consume(opts,t),expr={type:t,left:expr,right:tcalc__parseMulExpr(opts)},t=tcalc__peek(opts)}return expr}function tcalc__parseMulExpr(opts){for(var expr=tcalc__parsePrimaryExpr(opts),t=tcalc__peek(opts);"*"===t||"/"===t;){var rhs;tcalc__consume(opts,t),expr={type:t,left:expr,right:tcalc__parsePrimaryExpr(opts)},t=tcalc__peek(opts)}return expr}function tcalc__parsePrimaryExpr(opts){var t=tcalc__peek(opts);if(tcalc__isNumber(t))return tcalc__consume(opts,t),{type:"number",value:t};if(tcalc__isName(t))return tcalc__consume(opts,t),{type:"name",id:t};if("("===t){tcalc__consume(opts,t);var expr=tcalc__parseExpr(opts);if(")"!==tcalc__peek(opts))throw new SyntaxError("expected )");return tcalc__consume(opts,")"),expr}throw new SyntaxError("expected a number, a variable, or parentheses")}function tcalc__peek(opts){return opts.tokens[opts.position]}function tcalc__consume(opts,token){opts.position++}function tcalc__tokenize(code){for(var results=[],tokenRegExp=/\s*([A-Za-z]+|[0-9.]+|\S)\s*/g,m;null!==(m=tokenRegExp.exec(code));)results.push(m[1]);return results}function tcalc__isName(token){return void 0!==token&&null!==token.match(/^[A-Za-z]+$/)}function tcalc__isNumber(token){return void 0!==token&&null!==token.match(/^[0-9.]+$/)}